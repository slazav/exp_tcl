#!/usr/bin/wish

## Interface for current sweeps

package require Device 1.2

proc do_start {N} {
  global dest rate
  if { ! [string is double -strict $rate($N)] } { error "Rate  is not a number"  }
  if { ! [string is double -strict $dest($N)] } { error "Destinationis not a number" }
  if { $rate($N)<=0 } { error "Rate must be > 0" }
  if { $dest($N)<0  } { error "Destination must be >= 0" }
  sweep$N cmd "sweep [expr $dest($N)/1000.0] [expr $rate($N)/1000.0]"
}
proc do_stop {N} {
  sweep$N cmd sweep_stop
}
proc do_reset {N} {
  sweep$N cmd reset
}


proc make_int {N} {
  Device sweep$N

  labelframe .f$N -text {}
  label .f$N.curr    -textvariable curr($N) -font {-size 20} -width 7
  label .f$N.stat    -textvariable stat($N) -font {-size 15} -width 7
  entry .f$N.dest    -textvariable dest($N)
  label .f$N.dest_l  -text "Destination, mA"
  entry .f$N.rate    -textvariable rate($N)
  label .f$N.rate_l  -text "Rate, mA/s"

  button .f$N.start_btn -text "Start"  -command "do_start $N"
  button .f$N.stop_btn  -text "Stop"   -command "do_stop $N"
  button .f$N.reset_btn -text "Reset"  -command "do_reset $N"

  grid  .f$N.dest_l .f$N.dest .f$N.curr -sticky we
  grid  .f$N.rate_l .f$N.rate .f$N.stat -sticky we
  grid  .f$N.start_btn .f$N.stop_btn .f$N.reset_btn
  pack .f$N
}


for {set i 1} {$i<5} {incr i} { make_int $i }
button .exit -text "Exit"  -command exit
pack .exit -side right

proc update_curr {} {
  global curr stat dest rate
  for {set i 1} {$i<5} {incr i} {
    set c [sweep$i cmd get_mcurr]
    set stat($i) [sweep$i cmd get_stat]
    if { ! [string is double -strict $c] } { continue }
    set curr($i) [format %8.2f [expr $c*1000]]
    if { $dest($i) == {} } {set dest($i)  0}
    if { $rate($i) == {} } {set rate($i) 10}
  }
  after 2000 update_curr
}

after idle update_curr
set status idle


